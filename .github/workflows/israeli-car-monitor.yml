name: Car Monitor (Fixed)

on:
  schedule:
    # Run every 20 minutes from 6 AM to midnight
    - cron: '*/20 6-23 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-cars:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Restore car data from cache
      id: cache-restore
      uses: actions/cache/restore@v4
      with:
        path: seen_cars.json
        key: car-data-${{ github.run_number }}
        restore-keys: |
          car-data-
    
    - name: Run car scraper
      env:
        CAR_LISTING_URL: ${{ secrets.CAR_LISTING_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        STORAGE_FILE: seen_cars.json
      run: |
        python car_scraper.py
    
    - name: Save car data to cache
      if: always()
      uses: actions/cache/save@v4
      with:
        path: seen_cars.json
        key: car-data-${{ github.run_number }}