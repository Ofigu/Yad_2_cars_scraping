name: Yad2 Multi-URL Monitor

on:
  schedule:
    # Run every 20 minutes from 6 AM to midnight (Israel time)
    - cron: '*/20 6-23 * * *'
  
  # Manual trigger
  workflow_dispatch:

jobs:
  monitor-multiple:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Setup Chrome for Selenium
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-selenium-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-selenium-
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
        pip install selenium>=4.15.0
        pip install webdriver-manager>=4.0.1
    
    - name: Restore monitoring data
      id: cache-restore
      uses: actions/cache/restore@v4
      with:
        path: yad2_multi_data.json
        key: yad2-multi-${{ github.run_number }}
        restore-keys: |
          yad2-multi-
    
    - name: Show current status
      run: |
        echo "ðŸš— Yad2 Multi-URL Monitor"
        echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # Show how many URLs we're monitoring
        if [ -n "${{ secrets.CAR_LISTING_URLS }}" ]; then
          echo "Using CAR_LISTING_URLS (multiple)"
        else
          echo "Using CAR_LISTING_URL (single)"
        fi
        
        # Show previous data if exists
        if [ -f yad2_multi_data.json ]; then
          echo "Previous data found:"
          cat yad2_multi_data.json | python3 -c "
import json, sys
data = json.load(sys.stdin)
searches = data.get('searches', {})
print(f'Tracking {len(searches)} searches')
for key, search in list(searches.items())[:5]:
    print(f'  - {search[\"name\"]}: {search[\"last_total\"]} cars')
"
        else
          echo "First run - no previous data"
        fi
    
    - name: Run multi-URL monitor
      env:
        # Try CAR_LISTING_URLS first (multiple), fallback to CAR_LISTING_URL (single)
        CAR_LISTING_URLS: ${{ secrets.CAR_LISTING_URLS }}
        CAR_LISTING_URL: ${{ secrets.CAR_LISTING_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        STORAGE_FILE: yad2_multi_data.json
      run: |
        echo "Starting multi-URL monitor..."
        python yad2_multi_monitor.py
    
    - name: Save monitoring data
      if: always()
      uses: actions/cache/save@v4
      with:
        path: yad2_multi_data.json
        key: yad2-multi-${{ github.run_number }}
    
    - name: Show results summary
      if: always()
      run: |
        echo "=== Results Summary ==="
        if [ -f yad2_multi_data.json ]; then
          cat yad2_multi_data.json | python3 -c "
import json, sys
data = json.load(sys.stdin)
searches = data.get('searches', {})
print(f'Total searches monitored: {len(searches)}')
for key, search in searches.items():
    print(f'{search[\"name\"]}: {search[\"last_total\"]} cars')
"
        fi
        echo "==================="