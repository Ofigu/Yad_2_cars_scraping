name: Yad2 Multi-URL Monitor

on:
  schedule:
    # Run every 20 minutes from 6 AM to midnight (Israel time)
    - cron: '*/20 6-23 * * *'
  
  # Manual trigger
  workflow_dispatch:

jobs:
  monitor-yad2:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Setup Chrome for Selenium
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-selenium-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-selenium-
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
        pip install selenium>=4.15.0
        pip install webdriver-manager>=4.0.1
    
    - name: Restore monitoring data
      id: cache-restore
      uses: actions/cache/restore@v4
      with:
        path: |
          yad2_data_url1.json
          yad2_data_url2.json
        key: yad2-multi-${{ github.run_number }}
        restore-keys: |
          yad2-multi-
    
    - name: Show current status
      run: |
        echo "üöó Yad2 Multi-URL Monitor"
        echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        if [ -f yad2_data_url1.json ]; then
          echo "üìä URL 1 - Previous data found:"
          python3 -c "import json; data=json.load(open('yad2_data_url1.json')); print(f\"  Last total: {data.get('last_total', 0)}\"); print(f\"  Checks: {len(data.get('history', []))}\")"
        else
          echo "üìä URL 1 - First run"
        fi
        
        echo ""
        
        if [ -f yad2_data_url2.json ]; then
          echo "üìä URL 2 - Previous data found:"
          python3 -c "import json; data=json.load(open('yad2_data_url2.json')); print(f\"  Last total: {data.get('last_total', 0)}\"); print(f\"  Checks: {len(data.get('history', []))}\")"
        else
          echo "üìä URL 2 - First run"
        fi
    
    - name: Monitor URL 1
      continue-on-error: true
      env:
        CAR_LISTING_URL: ${{ secrets.CAR_LISTING_URL1 }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        STORAGE_FILE: yad2_data_url1.json
      run: |
        echo "=== Monitoring URL 1 ==="
        echo "URL: $CAR_LISTING_URL"
        python yad2_monitor.py
        echo ""
    
    - name: Wait between URLs
      run: sleep 5
    
    - name: Monitor URL 2
      continue-on-error: true
      env:
        CAR_LISTING_URL: ${{ secrets.CAR_LISTING_URL2 }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        STORAGE_FILE: yad2_data_url2.json
      run: |
        echo "=== Monitoring URL 2 ==="
        echo "URL: $CAR_LISTING_URL"
        python yad2_monitor.py
        echo ""
    
    - name: Save monitoring data
      if: always()
      uses: actions/cache/save@v4
      with:
        path: |
          yad2_data_url1.json
          yad2_data_url2.json
        key: yad2-multi-${{ github.run_number }}
    
    - name: Show results summary
      if: always()
      run: |
        echo "=== Results Summary ==="
        echo ""
        
        if [ -f yad2_data_url1.json ]; then
          echo "üìä URL 1: ‚úÖ"
          python3 -c "import json; data=json.load(open('yad2_data_url1.json')); print(f\"  Total: {data.get('last_total', 0)} cars\"); last=data.get('history',[]); print(f\"  Last change: {last[-1].get('change',0):+d}\") if last and 'change' in last[-1] else None"
        else
          echo "üìä URL 1: ‚ùå No data file created"
        fi
        
        echo ""
        
        if [ -f yad2_data_url2.json ]; then
          echo "üìä URL 2: ‚úÖ"
          python3 -c "import json; data=json.load(open('yad2_data_url2.json')); print(f\"  Total: {data.get('last_total', 0)} cars\"); last=data.get('history',[]); print(f\"  Last change: {last[-1].get('change',0):+d}\") if last and 'change' in last[-1] else None"
        else
          echo "üìä URL 2: ‚ùå No data file created - check if URL is valid"
        fi
        
        echo ""
        echo "====================="
